<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>‚ö†Ô∏è Alertes ‚Äì Contrats annul√©s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body { background-color: #f5f5f7; }

    /* ‚îÄ‚îÄ header ‚îÄ‚îÄ */
    .app-header {
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: white;
      border-radius: 1rem;
    }

    /* ‚îÄ‚îÄ carte imprimante ‚îÄ‚îÄ */
    .printer-card {
      border-radius: 1rem;
      border: 2px solid #dc3545;
      background-color: #fff5f5;
    }

    /* ‚îÄ‚îÄ badges priorit√© (m√™me palette que index.html) ‚îÄ‚îÄ */
    .badge-prio-1 { background-color: #dc3545; color: #fff; }
    .badge-prio-2 { background-color: #fd7e14; color: #fff; }
    .badge-prio-3 { background-color: #ffc107; color: #212529; }
    .badge-prio-4 { background-color: #198754; color: #fff; }

    /* ‚îÄ‚îÄ badge "Contrat annul√©" ‚îÄ‚îÄ */
    .badge-annule {
      background-color: #dc3545;
      color: #fff;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ chips du header ‚îÄ‚îÄ */
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.8rem;
      background-color: rgba(255,255,255,0.15);
      color: #f8f9fa;
      margin-right: 0.5rem;
    }
    .chip span { font-weight: 600; margin-right: 0.25rem; }
  </style>
</head>

<body>
  <div class="container py-4">

    <!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
    <div class="app-header p-4 mb-4 shadow">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h1 class="h3 mb-1">‚ö†Ô∏è Alertes ‚Äì Contrats annul√©s</h1>
          <p class="mb-0 opacity-75">
            Imprimantes dont le contrat est annul√© mais avec une date de fin pr√©vue.
            Les recommandations de toners sont masqu√©es sur l'accueil ; elles sont regroup√©es ici.
          </p>
        </div>
        <div class="text-end">
          <div class="chip"><span>Recommandations</span> {{ total_alertes }}</div>
          <div class="chip"><span>Imprimantes</span> {{ grouped_printers | length }}</div>
          <a href="/" class="btn btn-light btn-sm ms-2">‚Üê Retour √† l'accueil</a>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ LISTE DES IMPRIMANTES ‚îÄ‚îÄ -->
    {% if grouped_printers %}
      {% for printer in grouped_printers %}
        <div class="card printer-card shadow-sm mb-3">
          <div class="card-body">

            <!-- en-t√™te carte -->
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
              <div>
                <!-- serial ‚Üí lien vers la page d√©tail -->
                <h5 class="mb-1">
                  <a href="/printer/{{ printer.serial_display }}" class="text-decoration-none text-dark">
                    üñ®Ô∏è {{ printer.serial_display }}
                  </a>
                </h5>

                <!-- client / ville / contrat -->
                <div class="text-muted small">
                  {% if printer.client %}
                    <span><strong>Client :</strong> {{ printer.client }}</span>
                  {% endif %}
                  {% if printer.city %}
                    <span class="ms-3"><strong>Ville :</strong> {{ printer.city }}</span>
                  {% endif %}
                  {% if printer.contract %}
                    <span class="ms-3"><strong>Contrat :</strong> {{ printer.contract }}</span>
                  {% endif %}
                </div>

                <!-- badge "Contrat annul√© ‚Äì fin pr√©vue le ‚Ä¶" -->
                {% if printer.date_fin_contrat %}
                  <div class="mt-2">
                    <span class="badge badge-annule">
                      ‚ö†Ô∏è Contrat annul√© ‚Äì fin pr√©vue le {{ printer.date_fin_contrat }}
                    </span>
                  </div>
                {% endif %}
              </div>

              <!-- priorit√© min de cette imprimante -->
              <div class="text-end">
                {% if printer.min_priority is not none %}
                  <span class="badge badge-prio-{{ printer.min_priority }}">
                    P{{ printer.min_priority }}
                  </span>
                {% endif %}
              </div>
            </div>

            <!-- ‚îÄ‚îÄ TABLEAU TONERS ‚îÄ‚îÄ -->
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Toner</th>
                    <th>% actuel</th>
                    <th>Jours restants</th>
                    <th>Date rupture est.</th>
                    <th>Priorit√©</th>
                    <th>Commentaire</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in printer.rows %}
                    <tr>
                      <td>{{ row.get(col_toner, "") }}</td>
                      <td>
                        {% if row.get(col_last_pct) is not none %}
                          {{ row.get(col_last_pct) | round(0) | int }}%
                        {% else %}
                          ‚Äì
                        {% endif %}
                      </td>
                      <td>
                        {% if row.get(col_days) is not none and row.get(col_days) == row.get(col_days) %}
                          {{ row.get(col_days) | int }}
                        {% else %}
                          ‚Äì
                        {% endif %}
                      </td>
                      <td>{{ row.get(col_stockout, "‚Äì") }}</td>
                      <td>
                        {% if row.get(col_priority) is not none %}
                          <span class="badge badge-prio-{{ row.get(col_priority) | int }}">
                            P{{ row.get(col_priority) | int }}
                          </span>
                        {% endif %}
                      </td>
                      <td>{{ row.get(col_comment, "") }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div><!-- /card-body -->
        </div><!-- /card -->
      {% endfor %}

    {% else %}
      <!-- aucune alerte -->
      <div class="alert alert-success">
        <strong>‚úÖ Aucune alerte</strong> ‚Äì tous les contrats sont actifs ou sans date de fin pr√©vue.
      </div>
    {% endif %}

  </div><!-- /container -->
</body>
</html>