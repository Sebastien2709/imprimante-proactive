<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>‚ö†Ô∏è Alertes non prioritaires - Contrats annul√©s</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body { background-color: #f5f5f7; }
    .app-header {
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: white;
      border-radius: 1rem;
    }
    .printer-card {
      border-radius: 1rem;
      border: 2px solid #dc3545;
      background-color: #fff5f5;
    }
    .alert-badge {
      background-color: #dc3545;
      color: white;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    
    <!-- HEADER -->
    <div class="app-header p-4 mb-4 shadow">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1">‚ö†Ô∏è Alertes non prioritaires</h1>
          <p class="mb-0 opacity-75">Contrats annul√©s avec date de fin pr√©vue</p>
        </div>
        <div>
          <a href="/" class="btn btn-light">‚Üê Retour √† l'accueil</a>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div class="alert alert-danger mb-4">
      <strong>Total d'alertes :</strong> {{ total_alertes }} recommandation(s) concern√©e(s)
    </div>

    <!-- IMPRIMANTES -->
    {% if grouped_printers %}
      {% for printer in grouped_printers %}
        <div class="card printer-card shadow-sm mb-3">
          <div class="card-body">
            
            <!-- EN-T√äTE -->
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h5 class="mb-1">
                  <a href="/printer/{{ printer.serial_display }}" class="text-decoration-none">
                    üñ®Ô∏è {{ printer.serial_display }}
                  </a>
                </h5>
                <div class="text-muted small">
                  {% if printer.client %}<span><strong>Client:</strong> {{ printer.client }}</span>{% endif %}
                  {% if printer.city %}<span class="ms-3"><strong>Ville:</strong> {{ printer.city }}</span>{% endif %}
                  {% if printer.contract %}<span class="ms-3"><strong>Contrat:</strong> {{ printer.contract }}</span>{% endif %}
                </div>
                
                <!-- ALERTE CONTRAT ANNUL√â -->
                {% if printer.date_fin_contrat %}
                  <div class="mt-2">
                    <span class="badge alert-badge">
                      ‚ö†Ô∏è Contrat annul√© - Fin pr√©vue le {{ printer.date_fin_contrat }}
                    </span>
                  </div>
                {% endif %}
              </div>
              
              <div class="text-end">
                {% if printer.min_priority is not none %}
                  <span class="badge badge-prio-{{ printer.min_priority }} mb-1">P{{ printer.min_priority }}</span>
                {% endif %}
              </div>
            </div>

            <!-- TABLEAU DES TONERS -->
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Toner</th>
                    <th>Couleur</th>
                    <th>% actuel</th>
                    <th>Jours restants</th>
                    <th>Date rupture</th>
                    <th>Priorit√©</th>
                    <th>Commentaire</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in printer.rows %}
                    <tr>
                      <td>{{ row.get(col_toner, "") }}</td>
                      <td>{{ row.get("couleur", "") }}</td>
                      <td>
                        {% if row.get(col_last_pct) is not none %}
                          {{ row.get(col_last_pct) | round(0) }}%
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </td>
                      <td>{{ row.get(col_days, "‚Äî") }}</td>
                      <td>{{ row.get(col_stockout, "‚Äî") }}</td>
                      <td>
                        {% if row.get(col_priority) is not none %}
                          <span class="badge badge-prio-{{ row.get(col_priority) }}">
                            P{{ row.get(col_priority) }}
                          </span>
                        {% endif %}
                      </td>
                      <td>{{ row.get(col_comment, "") }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info">
        <strong>Aucune alerte non prioritaire</strong> - Tous les contrats sont actifs !
      </div>
    {% endif %}

  </div>
</body>
</html>