<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <title>Recommandations de toners (IA Adexgroup)</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <style>
      body { background-color: #f5f5f7; }
      .app-header {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        color: white;
        border-radius: 1rem;
      }
      .printer-card {
        border-radius: 1rem;
        border: 1px solid #e0e0e0;
      }
      .badge-prio-1 { background-color: #dc3545; }
      .badge-prio-2 { background-color: #fd7e14; }
      .badge-prio-3 { background-color: #ffc107; color: #212529; }
      .badge-prio-4 { background-color: #198754; }

      .chip {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        font-size: 0.8rem;
        background-color: rgba(255, 255, 255, 0.15);
        color: #f8f9fa;
        margin-right: 0.5rem;
      }
      .chip span { font-weight: 600; margin-right: 0.25rem; }

      .badge-type { font-size: 0.75rem; }
      .badge-type-contrat { background-color: #0d6efd; }
      .badge-type-commande { background-color: #6c757d; }
      .badge-type-stock { background-color: #0dcaf0; color: #212529; }
      .badge-type-inconnu { background-color: #adb5bd; }

      .btn-toner { margin-left: .35rem; margin-top: .15rem; }
      .slope-pill { font-size: .85rem; }
    </style>
  </head>

  <body>
    <div class="container py-4">

      <!-- Bandeau haut -->
      <div class="app-header p-4 mb-4 shadow-sm">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <div class="mb-2">
            <h1 class="h3 mb-1">Recommandations de toners (IA Adexgroup)</h1>
            <p class="mb-0 opacity-75">
              Liste des toners à envoyer, calculée automatiquement à partir des données KPAX + contrats (modèle V2.1).
            </p>
          </div>
          <div class="text-end">
            <div class="chip"><span>Total</span> {{ total_rows }}</div>
            <div class="chip"><span>À traiter</span> {{ pending_rows }}</div>
            <div class="chip"><span>Envoyés</span> {{ sent_rows }}</div>
          </div>
        </div>
      </div>

      <!-- Zone filtres -->
      <form class="row g-3 mb-4" method="get" action="/">
        <div class="col-md-4">
          <label class="form-label">Recherche n° de série</label>
          <input
            type="text"
            class="form-control"
            name="serial_query"
            placeholder="Ex : XAUV, NV0L..."
            value="{{ serial_query }}"
          >
        </div>

        <div class="col-md-3">
          <label class="form-label">Priorité</label>
          <select class="form-select" name="priority">
            <option value="">Toutes</option>
            {% for p in priorities %}
              <option value="{{ p }}" {% if p|string == selected_priority %}selected{% endif %}>
                {{ p }}
              </option>
            {% endfor %}
          </select>
          <small class="text-muted">1 = critique, 4 = faible</small>
        </div>

        <div class="col-md-3">
          <label class="form-label">Type de livraison</label>
          <select class="form-select" name="type_livraison">
            <option value="">Tous les types</option>
            {% for tl in type_liv_options %}
              <option value="{{ tl }}" {% if tl == selected_type_liv %}selected{% endif %}>
                {% if tl == "contrat_maintenance" %}Contrat de maintenance
                {% elif tl == "commande_simple" %}Commande simple
                {% elif tl == "stock_seulement" %}Stock seulement
                {% else %}{{ tl }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Filtre serveur rupture -->
        <div class="col-12">
          <label class="form-label">Rupture (KPAX muet / dernière remontée trop ancienne)</label>
          <div class="btn-group" role="group" aria-label="Filtre rupture">
            <input type="radio" class="btn-check" name="rupture_mode" id="rupt_all" value="all"
              {% if rupture_mode == "all" %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="rupt_all">Tout</label>

            <input type="radio" class="btn-check" name="rupture_mode" id="rupt_ok" value="ok"
              {% if rupture_mode == "ok" %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="rupt_ok">OK</label>

            <input type="radio" class="btn-check" name="rupture_mode" id="rupt_rupture" value="rupture"
              {% if rupture_mode == "rupture" %}checked{% endif %}>
            <label class="btn btn-outline-primary" for="rupt_rupture">Rupture ?</label>
          </div>
        </div>

        <div class="col-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary me-2">Filtrer</button>
          <a href="/" class="btn btn-primary me-2">Réinitialiser</a>
        </div>
      </form>

      <!-- Graphiques de synthèse -->
      <div class="row mb-4">
        <div class="col-md-6 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Répartition par priorité</h5>
              <canvas id="priorityChart" height="180"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-3">Répartition par couleur de toner</h5>
              <canvas id="colorChart" height="180"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Liste des imprimantes regroupées -->
      {% if grouped_printers %}
        {% for printer in grouped_printers %}
          <div class="card printer-card shadow-sm mb-3">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
              <div class="mb-2">
                <strong>Imprimante :</strong> {{ printer.serial_display }}

                <a
                  class="btn btn-sm btn-primary ms-2"
                  href="/printer/{{ printer.serial_display }}"
                >
                  Détails
                </a>

                <div class="mt-2" data-slopes-for="{{ printer.serial_display }}"></div>

                {% if printer.client %}
                  <span class="ms-3"><strong>Client :</strong> {{ printer.client }}</span>
                {% endif %}
                {% if printer.contract %}
                  <span class="ms-3 text-muted">Contrat : {{ printer.contract }}</span>
                {% endif %}
                {% if printer.city %}
                  <span class="ms-3 text-muted">Ville : {{ printer.city }}</span>
                {% endif %}
                {% if printer.min_stockout_date %}
                  <span class="ms-3 text-muted">
                    Prochaine rupture estimée : <strong>{{ printer.min_stockout_date }}</strong>
                  </span>
                {% endif %}
                {% if printer.min_days_left is not none %}
                  <span class="ms-3 text-muted">
                    Jours restants min : <strong>{{ printer.min_days_left|round(0) }}</strong>
                  </span>
                {% endif %}

                <!-- Boutons rapides par toner (couleur) -->
                {% if printer.colors_present and printer.colors_present|length > 0 %}
                  <div class="mt-2">
                    <span class="text-muted me-2">Pente rapide :</span>
                    {% for c in printer.colors_present %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-primary btn-toner slope-btn"
                        data-serial="{{ printer.serial_display }}"
                        data-color="{{ c }}"
                        data-bs-toggle="modal"
                        data-bs-target="#slopeModal"
                      >
                        {{ c }}
                      </button>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <div class="mb-2">
                {% if printer.min_priority is not none %}
                  {% set p = printer.min_priority %}
                  <span class="badge
                    {% if p == 1 %}badge-prio-1
                    {% elif p == 2 %}badge-prio-2
                    {% elif p == 3 %}badge-prio-3
                    {% else %}badge-prio-4{% endif %}">
                    Priorité min : {{ printer.min_priority }}
                  </span>
                {% endif %}
              </div>
            </div>

            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 4%">ID</th>
                      <th style="width: 10%">Toner</th>
                      <th style="width: 7%">Couleur</th>
                      <th style="width: 9%">Jours restants</th>
                      <th style="width: 13%">Date rupture estimée</th>
                      <th style="width: 8%">Priorité</th>
                      <th style="width: 10%">Dernière remontée</th>
                      <th style="width: 8%">Rupture ?</th>
                      <th style="width: 6%">% actuel</th>
                      <th style="width: 13%">Client</th>
                      <th style="width: 8%">Ville</th>
                      <th style="width: 12%">Type livraison</th>
                      <th style="width: 15%">Commentaire</th>
                      <th style="width: 7%">Statut</th>
                      <th style="width: 10%">Pente</th>
                      <th style="width: 12%">Action</th>
                    </tr>
                  </thead>

                  <tbody>
                    {% for r in printer.rows %}
                      {% set rid = r[col_id] %}
                      {% set prio = r.get(col_priority) %}
                      {% set is_rupture = r.get('rupture_kpax') %}

                      {% set color_val = (r.get('couleur_norm') or r.get('couleur') or '') %}
                      {% set color_val = color_val|string|lower|trim %}

                      <tr
                        data-rupture="{{ 1 if is_rupture else 0 }}"
                        class="{% if rid in processed_ids %}table-success{% endif %}"
                      >
                        <td>{{ rid }}</td>
                        <td>{{ r.get(col_toner, '') }}</td>
                        <td>{{ r.get('couleur', '') }}</td>
                        <td>{{ r.get(col_days, '') }}</td>
                        <td>{{ r.get(col_stockout, '') }}</td>

                        <td>
                          {% if prio is not none %}
                            <span class="badge
                              {% if prio == 1 %}badge-prio-1
                              {% elif prio == 2 %}badge-prio-2
                              {% elif prio == 3 %}badge-prio-3
                              {% else %}badge-prio-4{% endif %}">
                              P{{ prio }}
                            </span>
                          {% endif %}
                        </td>

                        <td>{{ r.get(col_last_update, '') }}</td>

                        <td>
                          {% if is_rupture %}
                            <span class="badge bg-warning text-dark">Rupture ?</span>
                          {% else %}
                            <span class="badge bg-success">OK</span>
                          {% endif %}
                        </td>

                        <td>
                          {% if r.get(col_last_pct) is not none %}
                            {{ r.get(col_last_pct) | round(0) }}%
                          {% endif %}
                        </td>

                        <td>{{ r.get(col_client, '') }}</td>
                        <td>{{ r.get(col_city, '') }}</td>

                        <td>
                          {% set tl = r.get(col_type_liv, '') %}
                          {% if tl == "contrat_maintenance" %}
                            <span class="badge badge-type badge-type-contrat">Contrat maintenance</span>
                          {% elif tl == "commande_simple" %}
                            <span class="badge badge-type badge-type-commande">Commande simple</span>
                          {% elif tl == "stock_seulement" %}
                            <span class="badge badge-type badge-type-stock">Stock seulement</span>
                          {% elif tl %}
                            <span class="badge badge-type badge-type-inconnu">{{ tl }}</span>
                          {% endif %}
                        </td>

                        <td>{{ r.get(col_comment, '') }}</td>

                        <td>
                          {% if rid in processed_ids %}
                            ✅ Envoyé
                          {% else %}
                            ⏳ À traiter
                          {% endif %}
                        </td>

                        <!-- ✅ Bouton pente par toner -->
                        <td>
                          {% if color_val %}
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-dark slope-btn"
                              data-serial="{{ printer.serial_display }}"
                              data-color="{{ color_val }}"
                              data-bs-toggle="modal"
                              data-bs-target="#slopeModal"
                            >
                              Voir
                            </button>
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>

                        <td>
                          {% if rid not in processed_ids %}
                            <form method="post" action="{{ url_for('mark_processed', row_id=rid) }}">
                              <button type="submit" class="btn btn-sm btn-outline-success">
                                Marquer comme envoyé
                              </button>
                            </form>
                          {% else %}
                            <form method="post" action="{{ url_for('mark_unprocessed', row_id=rid) }}">
                              <button type="submit" class="btn btn-sm btn-outline-warning">
                                Annuler
                              </button>
                            </form>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>

                </table>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-info">
          Aucune recommandation trouvée avec ces filtres.
        </div>
      {% endif %}
    </div>

    <!-- ✅ MODAL PENTE -->
    <div class="modal fade" id="slopeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 class="modal-title mb-1">Pente de consommation</h5>
              <div class="text-muted small" id="slopeSubtitle"></div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>

          <div class="modal-body">
            <div class="d-flex gap-2 flex-wrap align-items-center mb-3">
              <label class="form-label mb-0 me-2">Toner :</label>
              <select class="form-select form-select-sm" id="slopeColorSelect" style="max-width: 220px;">
                <option value="black">black</option>
                <option value="cyan">cyan</option>
                <option value="magenta">magenta</option>
                <option value="yellow">yellow</option>
              </select>

              <span class="badge bg-light text-dark slope-pill" id="slopeValuePill">
                pente: —
              </span>
              <span class="text-muted small" id="slopeSource"></span>
            </div>

            <div class="alert alert-warning d-none" id="slopeWarn"></div>

            <canvas id="slopeChart" height="140"></canvas>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script id="priority-data" type="application/json">
      {{ priority_counts | tojson }}
    </script>
    <script id="color-data" type="application/json">
      {{ color_counts | tojson }}
    </script>

    <script>
      const priorityCounts = JSON.parse(document.getElementById("priority-data").textContent);
      const colorCounts = JSON.parse(document.getElementById("color-data").textContent);

      // Graphique par priorité
      const prCtx = document.getElementById('priorityChart');
      if (prCtx && Object.keys(priorityCounts).length > 0) {
        new Chart(prCtx, {
          type: 'bar',
          data: { labels: Object.keys(priorityCounts), datasets: [{ label: 'Nb de toners', data: Object.values(priorityCounts) }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      }

      // Graphique par couleur
      const colCtx = document.getElementById('colorChart');
      if (colCtx && Object.keys(colorCounts).length > 0) {
        new Chart(colCtx, {
          type: 'bar',
          data: { labels: Object.keys(colorCounts), datasets: [{ label: 'Nb de toners', data: Object.values(colorCounts) }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      }

      // ------------------------------------------------------------
      // ✅ MODAL + CHART PENTE
      // ------------------------------------------------------------
      const slopeModal = document.getElementById('slopeModal');
      const slopeSubtitle = document.getElementById('slopeSubtitle');
      const slopeColorSelect = document.getElementById('slopeColorSelect');
      const slopeValuePill = document.getElementById('slopeValuePill');
      const slopeSource = document.getElementById('slopeSource');
      const slopeWarn = document.getElementById('slopeWarn');

      let slopeChart = null;
      let currentSerial = null;

      const COLOR_MAP = {
        black: "rgb(0,0,0)",
        cyan: "rgb(0,174,239)",
        magenta: "rgb(236,0,140)",
        yellow: "rgb(255,242,0)",
      };

      function destroySlopeChart() {
        if (slopeChart) {
          slopeChart.destroy();
          slopeChart = null;
        }
      }

      function setWarn(msg) {
        if (!msg) {
          slopeWarn.classList.add("d-none");
          slopeWarn.textContent = "";
          return;
        }
        slopeWarn.textContent = msg;
        slopeWarn.classList.remove("d-none");
      }

      async function loadAndRender(serial, color) {
        currentSerial = serial;
        const c = (color || "black").toLowerCase();

        slopeSubtitle.textContent = `Imprimante: ${serial}`;
        slopeColorSelect.value = c;

        slopeValuePill.textContent = "pente: …";
        slopeSource.textContent = "";
        setWarn(null);

        destroySlopeChart();

        const url = `/api/consumption?serial=${encodeURIComponent(serial)}&color=${encodeURIComponent(c)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
          setWarn("Erreur: " + data.error);
          slopeValuePill.textContent = "pente: —";
          return;
        }

        const slope = data.slope_pct_per_day;
        if (slope === null || slope === undefined) {
          slopeValuePill.textContent = "pente: —";
        } else {
          const s = Number(slope);
          slopeValuePill.textContent = `pente: ${s.toFixed(3)} %/jour`;
        }

        if (data.slope_source) {
          slopeSource.textContent = `(source: ${data.slope_source})`;
        }

        const points = data.points || [];
        if (!points.length) {
          setWarn("Aucun historique KPAX trouvé pour ce toner. (On affiche seulement la pente si disponible via forecasts)");
          return;
        }

        const labels = points.map(p => p.date);
        const values = points.map(p => p.pct);

        const lineColor = COLOR_MAP[c] || "rgb(0,0,0)";

        const ctx = document.getElementById("slopeChart");
        slopeChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: `% toner (${c})`,
              data: values,
              tension: 0.25,
              pointRadius: 2,
              borderColor: lineColor,
              backgroundColor: lineColor
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
              y: { beginAtZero: true, suggestedMax: 100 }
            }
          }
        });
      }

      // Click bouton "Voir pente"
      document.querySelectorAll(".slope-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const serial = btn.dataset.serial;
          const color = btn.dataset.color || "black";
          loadAndRender(serial, color);
        });
      });

      // Changement de toner dans la modal
      slopeColorSelect.addEventListener("change", () => {
        if (!currentSerial) return;
        loadAndRender(currentSerial, slopeColorSelect.value);
      });

      // Clean quand on ferme la modal
      slopeModal.addEventListener("hidden.bs.modal", () => {
        destroySlopeChart();
        currentSerial = null;
        setWarn(null);
        slopeValuePill.textContent = "pente: —";
      });
    </script>

    <script>
      function formatSlope(v) {
        if (v === null || v === undefined || Number.isNaN(v)) return "—";
        const n = Number(v);
        return `${n.toFixed(3)} %/jour`;
      }

      function slopeBadge(color, value) {
        const txt = formatSlope(value);
        return `
          <span class="badge bg-light text-dark me-2 mb-1">
            <strong>${color}</strong> : ${txt}
          </span>
        `;
      }

      async function loadPrinterSlopes(serial) {
        const container = document.querySelector(`[data-slopes-for="${CSS.escape(serial)}"]`);
        if (!container) return;

        container.innerHTML = `<span class="text-muted small">Chargement…</span>`;

        const url = `/api/slopes?serial=${encodeURIComponent(serial)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
          container.innerHTML = `<span class="text-danger small">Erreur: ${data.error}</span>`;
          return;
        }

        const s = data.slopes || {};
        container.innerHTML = `
          <div class="d-flex flex-wrap align-items-center">
            ${slopeBadge("black", s.black)}
            ${slopeBadge("cyan", s.cyan)}
            ${slopeBadge("magenta", s.magenta)}
            ${slopeBadge("yellow", s.yellow)}
          </div>
          <div class="text-muted small mt-1">
            (pente = régression linéaire, %/jour ; “—” si pas assez de points)
          </div>
        `;
      }

      // Si tu ajoutes un bouton dédié pour charger les pentes imprimante,
      // donne-lui la classe "printer-slopes-btn" et un data-serial.
      document.querySelectorAll(".printer-slopes-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const serial = btn.dataset.serial;
          loadPrinterSlopes(serial);
        });
      });
    </script>

  </body>
</html>
