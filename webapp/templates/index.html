<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Recommandations de toners ‚Äî Adexgroup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    /* ============================================================
       TOKENS & RESET
       ============================================================ */
    :root {
      --bg:          #0f1117;
      --surface:     #161820;
      --surface2:    #1e2028;
      --border:      #2a2d35;
      --text:        #e2e4e9;
      --text-muted:  #7a7f8e;
      --accent:      #6c63ff;
      --accent-hover:#7f78ff;
      --red:         #ef4444;
      --orange:      #f59e0b;
      --green:       #22c55e;
      --cyan:        #06b6d4;
      --prio1:       #ef4444;
      --prio2:       #f59e0b;
      --prio3:       #eab308;
      --prio4:       #22c55e;
    }

    /* ============================================================
       LIGHT OVERRIDE
       ============================================================ */
    html.light {
      --bg:          #f0f2f5;
      --surface:     #ffffff;
      --surface2:    #f4f6f9;
      --border:      #dde1e7;
      --text:        #1e2028;
      --text-muted:  #6b7280;
      --accent:      #5b52e5;
      --accent-hover:#4a43d4;
      --red:         #dc2626;
      --orange:      #d97706;
      --green:       #16a34a;
      --cyan:        #0891b2;
      --prio1:       #dc2626;
      --prio2:       #d97706;
      --prio3:       #ca8a04;
      --prio4:       #16a34a;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      margin: 0;
      transition: background .3s, color .3s;
    }

    /* ============================================================
       TOP HEADER BAR
       ============================================================ */
    .top-bar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .top-bar .logo {
      font-family: 'DM Mono', monospace;
      font-weight: 500;
      font-size: 1rem;
      color: var(--accent);
      letter-spacing: 0.04em;
    }
    .top-bar .logo span { color: var(--text-muted); }

    .stat-chips {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .stat-chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .stat-chip .label { color: var(--text-muted); }
    .stat-chip .val   { font-weight: 600; color: var(--text); }

    /* Alertes CTA ‚Äî always visible */
    .btn-alertes {
      background: var(--red);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.35rem 0.85rem;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s;
    }
    .btn-alertes:hover { background: #dc2626; color:#fff; text-decoration:none; }
    .btn-alertes .badge-count {
      background: rgba(255,255,255,0.25);
      border-radius: 999px;
      padding: 0.05rem 0.45rem;
      font-size: 0.75rem;
    }

    /* ============================================================
       MAIN LAYOUT
       ============================================================ */
    .main-wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.75rem 1.5rem;
    }

    /* ============================================================
       SECTION TITLE
       ============================================================ */
    .section-head {
      display: flex;
      align-items: baseline;
      gap: 0.6rem;
      margin-bottom: 0.35rem;
    }
    .section-head h2 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--text);
    }
    .section-head .sub {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* ============================================================
       FILTER BAR
       ============================================================ */
    .filter-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
    }
    .filter-bar .form-label {
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.25rem;
    }
    .filter-bar .form-control,
    .filter-bar .form-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      font-size: 0.85rem;
      padding: 0.4rem 0.65rem;
    }
    .filter-bar .form-control:focus,
    .filter-bar .form-select:focus {
      background: var(--surface2);
      border-color: var(--accent);
      color: var(--text);
      box-shadow: 0 0 0 2px rgba(108,99,255,0.25);
    }
    .filter-bar .form-select option { background: var(--surface2); color: var(--text); }

    /* radio group "Suivi KPAX" */
    .kpax-group {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .kpax-group input[type=radio] { display: none; }
    .kpax-group label {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s;
    }
    .kpax-group input[type=radio]:checked + label {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .kpax-group label:hover { border-color: var(--accent); color: var(--text); }

    .filter-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 0.75rem;
    }
    .btn-filter {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.35rem 1rem;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-filter:hover { background: var(--accent-hover); }
    .btn-reset {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.35rem 1rem;
      font-size: 0.82rem;
      cursor: pointer;
      text-decoration: none;
      transition: border-color 0.15s;
    }
    .btn-reset:hover { border-color: var(--accent); color: var(--text); text-decoration:none; }

    /* ============================================================
       CHARTS ROW
       ============================================================ */
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.75rem;
    }
    @media (max-width: 640px) { .charts-row { grid-template-columns: 1fr; } }

    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.25rem;
    }
    .chart-card h4 {
      margin: 0 0 0.75rem;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ============================================================
       PRINTER CARDS
       ============================================================ */
    .printer-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 1rem;
      overflow: hidden;
      transition: border-color 0.2s;
    }
    .printer-card:hover { border-color: var(--accent); }

    /* Card header */
    .pc-header {
      padding: 0.85rem 1.1rem 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .pc-serial {
      font-family: 'DM Mono', monospace;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .pc-serial .icon { font-size: 0.95rem; }

    .pc-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.9rem;
      margin-top: 0.3rem;
    }
    .pc-meta span {
      font-size: 0.79rem;
      color: var(--text-muted);
    }
    .pc-meta strong { color: var(--text); font-weight: 600; }

    .pc-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.45rem;
    }

    /* Prio badge */
    .badge-prio {
      display: inline-block;
      border-radius: 6px;
      padding: 0.15rem 0.55rem;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: #fff;
    }
    .badge-prio-0 { background: #7c3aed }
    .badge-prio-1 { background: var(--prio1); }
    .badge-prio-2 { background: var(--prio2); }
    .badge-prio-3 { background: var(--prio3); color:#1a1a1a; }
    .badge-prio-4 { background: var(--prio4); }

    @keyframes pulse-p0 {
      0%,100% { box-shadow: 0 0 0 0 rgba(124,58,237,0.6); }
      50%      { box-shadow: 0 0 0 6px rgba(124,58,237,0); }
    }

    /* Badge toner inchang√© */
    .badge-unchanged {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: rgba(124,58,237,0.15);
      border: 1px solid rgba(124,58,237,0.4);
      border-radius: 6px;
      padding: 0.12rem 0.5rem;
      font-size: 0.72rem;
      font-weight: 600;
      color: #a78bfa;
      white-space: nowrap;
    }

    /* Bouton filtre rapide "toner inchang√©" dans la top-bar */
    .btn-unchanged {
      background: rgba(124,58,237,0.2);
      color: #a78bfa;
      border: 1px solid rgba(124,58,237,0.4);
      border-radius: 8px;
      padding: 0.35rem 0.85rem;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s;
    }
    .btn-unchanged:hover { background: rgba(124,58,237,0.35); color: #c4b5fd; text-decoration:none; }
    .btn-unchanged .badge-count {
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
      padding: 0.05rem 0.45rem;
      font-size: 0.75rem;
    }

    /* Type-livraison badge */
    .badge-type {
      display: inline-block;
      border-radius: 6px;
      padding: 0.12rem 0.5rem;
      font-size: 0.73rem;
      font-weight: 600;
    }
    .badge-type-contrat   { background: rgba(108,99,255,0.18); color: var(--accent); }
    .badge-type-commande  { background: rgba(124,139,161,0.2); color: #9ba7b8; }
    .badge-type-stock     { background: rgba(6,182,212,0.18);  color: var(--cyan); }
    .badge-type-inconnu   { background: rgba(124,139,161,0.15); color: #7a7f8e; }

    /* KPAX status badge */
    .badge-kpax-ok   { background: rgba(34,197,94,0.15);  color: var(--green); }
    .badge-kpax-warn { background: rgba(245,158,11,0.15); color: var(--orange); }

    /* Slope pills row */
    .slopes-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.4rem;
    }
    .slope-pill {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.12rem 0.5rem;
      font-size: 0.73rem;
      font-family: 'DM Mono', monospace;
      color: var(--text-muted);
    }
    .slope-pill strong { color: var(--text); }

    /* Toner quick-buttons */
    .toner-btns { display:flex; gap:0.3rem; flex-wrap:wrap; margin-top:0.4rem; }
    .btn-toner-quick {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.15rem 0.55rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-toner-quick:hover { border-color: var(--accent); color: var(--text); }

    /* D√©tails link */
    .btn-detail {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      transition: background 0.15s;
    }
    .btn-detail:hover { background: var(--accent); color:#fff; text-decoration:none; }

    /* Alerte contrat fin proche */
    .alert-fin-proche {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: rgba(245,158,11,0.12);
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 6px;
      padding: 0.18rem 0.55rem;
      font-size: 0.75rem;
      color: var(--orange);
      margin-top: 0.35rem;
    }

    /* ============================================================
       TABLE INSIDE CARD
       ============================================================ */
    .pc-table-wrap {
      border-top: 1px solid var(--border);
      overflow-x: auto;
    }
    table.toner-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    table.toner-table th {
      background: var(--surface2);
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      padding: 0.5rem 0.75rem;
      text-align: left;
      white-space: nowrap;
      border-bottom: 1px solid var(--border);
    }
    table.toner-table td {
      padding: 0.55rem 0.75rem;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      vertical-align: middle;
    }
    table.toner-table tr:last-child td { border-bottom: none; }
    table.toner-table tr:hover td { background: rgba(108,99,255,0.04); }

    /* Row sent (processed) */
    table.toner-table tr.row-sent td { opacity: 0.55; }
    table.toner-table tr.row-sent { background: rgba(34,197,94,0.06); }

    /* Action buttons in table */
    .btn-mark {
      background: transparent;
      border: 1px solid var(--green);
      color: var(--green);
      border-radius: 6px;
      padding: 0.18rem 0.6rem;
      font-size: 0.73rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-mark:hover { background: var(--green); color: #fff; }

    .btn-unmark {
      background: transparent;
      border: 1px solid var(--orange);
      color: var(--orange);
      border-radius: 6px;
      padding: 0.18rem 0.6rem;
      font-size: 0.73rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-unmark:hover { background: var(--orange); color: #fff; }

    .badge-sent {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(34,197,94,0.15);
      color: var(--green);
      border-radius: 6px;
      padding: 0.12rem 0.45rem;
      font-size: 0.72rem;
      font-weight: 600;
    }

    /* "Voir" consumption btn */
    .btn-consumption {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 6px;
      padding: 0.15rem 0.5rem;
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-consumption:hover { border-color: var(--accent); color: var(--accent); }

    /* ============================================================
       EMPTY STATE
       ============================================================ */
    .empty-state {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
    }
    .empty-state .icon { font-size: 2.2rem; margin-bottom: 0.5rem; }

    /* ============================================================
       MODAL
       ============================================================ */
    .modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text);
    }
    .modal-header { border-bottom: 1px solid var(--border); padding: 1rem 1.25rem; }
    .modal-header .btn-close { filter: invert(1); }
    .modal-title { font-size: 1rem; font-weight: 600; }
    .modal-body { padding: 1.25rem; }
    .modal-footer { border-top: 1px solid var(--border); padding: 0.75rem 1.25rem; justify-content:flex-end; display:flex; }

    .modal-subtitle { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.15rem; }

    .slope-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      padding: 0.3rem 0.55rem;
      font-size: 0.82rem;
      max-width: 160px;
    }
    .slope-select option { background: var(--surface2); }

    .slope-value-pill {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.2rem 0.6rem;
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      color: var(--text);
    }
    .slope-source { color: var(--text-muted); font-size: 0.72rem; }

    .alert-warn-modal {
      background: rgba(245,158,11,0.1);
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 8px;
      padding: 0.55rem 0.75rem;
      font-size: 0.8rem;
      color: var(--orange);
      margin-bottom: 0.75rem;
    }
    .alert-warn-modal.d-none { display: none !important; }

    .btn-modal-close {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 6px;
      padding: 0.3rem 0.85rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-modal-close:hover { border-color: var(--accent); color: var(--text); }

    /* ============================================================
       THEME TOGGLE PILL
       ============================================================ */
    .theme-toggle {
      display: flex;
      align-items: center;
      width: 48px; height: 26px;
      border-radius: 13px;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      cursor: pointer;
      padding: 0 2px;
      transition: background .3s, border-color .3s;
      position: relative;
    }
    .theme-toggle:hover { border-color: var(--accent); }

    .theme-toggle .knob {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--accent);
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; line-height: 1;
      box-shadow: 0 1px 4px rgba(0,0,0,.25);
      transition: transform .3s cubic-bezier(.4,0,.2,1);
      /* dark = left (default) */
    }
    html.light .theme-toggle .knob {
      transform: translateX(22px);   /* slide right in light */
    }

    /* modal close ‚úï ‚Äî invert only in dark */
    .modal-header .btn-close { filter: invert(1); }
    html.light .modal-header .btn-close { filter: none; }

    /* ============================================================
       SCROLLBAR (webkit)
       ============================================================ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>

<body>

<!-- ============================================================
     TOP BAR
     ============================================================ -->
<nav class="top-bar">
  <div class="logo">toner<span>.</span>ai <span style="color:var(--text-muted); font-family:'DM Sans',sans-serif; font-weight:500; font-size:0.82rem;"> ‚Äî Adexgroup v2.1</span></div>
  <div class="stat-chips">
    <!-- theme toggle üåô / ‚òÄÔ∏è -->
    <button class="theme-toggle" id="themeToggle" aria-label="Basculer th√®me">
      <span class="knob" id="themeIcon">üåô</span>
    </button>
    <!-- Alertes button ‚Äî ALWAYS visible -->
    <a href="/alertes" class="btn-alertes">
      ‚ö†Ô∏è Alertes
      <span class="badge-count">{{ nb_alertes_non_prioritaires }}</span>
    </a>
    <!-- Toner inchang√© button -->
    {% if nb_inchanges > 0 %}
    <a href="/?filtre_inchange=1" class="btn-unchanged">
      üîî Toner inchang√©
      <span class="badge-count">{{ nb_inchanges }}</span>
    </a>
    {% endif %}
    <div class="stat-chip"><span class="label">Total</span><span class="val">{{ total_rows }}</span></div>
    <div class="stat-chip"><span class="label">√Ä traiter</span><span class="val">{{ pending_rows }}</span></div>
    <div class="stat-chip"><span class="label">Envoy√©s</span><span class="val">{{ sent_rows }}</span></div>
  </div>
</nav>

<!-- ============================================================
     MAIN
     ============================================================ -->
<div class="main-wrap">

  <!-- ---- FILTER BAR ---- -->
  <form class="filter-bar" method="get" action="/">
    <div class="row g-3 align-items-end">
      <div class="col-md-4 col-12">
        <label class="form-label">Recherche s√©rie</label>
        <input type="text" class="form-control" name="serial_query" placeholder="Ex : XAUV, NV0L‚Ä¶" value="{{ serial_query }}">
      </div>

      <div class="col-md-2 col-6">
        <label class="form-label">Priorit√©</label>
        <select class="form-select" name="priority">
          <option value="">Toutes</option>
          {% for p in priorities %}
            <option value="{{ p }}" {% if p|string == selected_priority %}selected{% endif %}>P{{ p }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3 col-6">
        <label class="form-label">Type livraison</label>
        <select class="form-select" name="type_livraison">
          <option value="">Tous</option>
          {% for tl in type_liv_options %}
            <option value="{{ tl }}" {% if tl == selected_type_liv %}selected{% endif %}>
              {% if tl == "contrat_maintenance" %}Contrat maintenance
              {% elif tl == "commande_simple" %}Commande simple
              {% elif tl == "stock_seulement" %}Stock seulement
              {% else %}{{ tl }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3 col-12">
        <label class="form-label">Suivi KPAX</label>
        <div class="kpax-group">
          <input type="radio" name="rupture_mode" id="rupt_all" value="all" {% if rupture_mode == "all" %}checked{% endif %}>
          <label for="rupt_all">Tout</label>

          <input type="radio" name="rupture_mode" id="rupt_ok" value="ok" {% if rupture_mode == "ok" %}checked{% endif %}>
          <label for="rupt_ok">‚úÖ √Ä jour</label>

          <input type="radio" name="rupture_mode" id="rupt_rupture" value="rupture" {% if rupture_mode == "rupture" %}checked{% endif %}>
          <label for="rupt_rupture">‚ö†Ô∏è Pas de donn√©es</label>
        </div>
      </div>

      <!-- Filtre jours n√©gatifs (P0) -->
      <div class="col-md-2 col-6">
        <label class="form-label">En retard</label>
        <div class="kpax-group">
          <input type="radio" name="filtre_negatif" id="neg_all" value="" {% if not filtre_negatif %}checked{% endif %}>
          <label for="neg_all">Tous</label>
          <input type="radio" name="filtre_negatif" id="neg_only" value="1" {% if filtre_negatif %}checked{% endif %}>
          <label for="neg_only" style="color:#a78bfa">üî¥ P0 uniquement</label>
        </div>
      </div>

      <!-- Filtre toner inchang√© -->
      <div class="col-md-2 col-6">
        <label class="form-label">Toner inchang√©</label>
        <div class="kpax-group">
          <input type="radio" name="filtre_inchange" id="inc_all" value="" {% if not filtre_inchange %}checked{% endif %}>
          <label for="inc_all">Tous</label>
          <input type="radio" name="filtre_inchange" id="inc_only" value="1" {% if filtre_inchange %}checked{% endif %}>
          <label for="inc_only" style="color:#a78bfa">üîî Inchang√©s</label>
        </div>
      </div>
    </div>

    <!-- pending hidden -->
    {% if show_only_pending %}
      <input type="hidden" name="pending" value="1">
    {% endif %}

    <div class="filter-actions">
      <button type="submit" class="btn-filter">Filtrer</button>
      <a href="/" class="btn-reset">R√©initialiser</a>
    </div>
  </form>

  <!-- ---- CHARTS ---- -->
  <div class="charts-row">
    <div class="chart-card">
      <h4>R√©partition par priorit√©</h4>
      <canvas id="priorityChart" height="140"></canvas>
    </div>
    <div class="chart-card">
      <h4>R√©partition par couleur</h4>
      <canvas id="colorChart" height="140"></canvas>
    </div>
  </div>

  <!-- ---- PRINTER CARDS ---- -->
  {% if grouped_printers %}
    {% for printer in grouped_printers %}
    <div class="printer-card">

      <!-- HEADER -->
      <div class="pc-header">
        <div>
          <div class="pc-serial">
            <span class="icon">üñ®Ô∏è</span>
            {{ printer.serial_display }}
            <a href="/printer/{{ printer.serial_display }}" class="btn-detail">D√©tails ‚Üí</a>
          </div>

          <div class="pc-meta">
            {% if printer.client %}  <span><strong>Client</strong> {{ printer.client }}</span>{% endif %}
            {% if printer.city %}    <span><strong>Ville</strong> {{ printer.city }}</span>{% endif %}
            {% if printer.contract %}<span><strong>Contrat</strong> {{ printer.contract }}</span>{% endif %}
            {% if printer.min_stockout_date %}<span><strong>Rupture la plus proche</strong> {{ printer.min_stockout_date }}</span>{% endif %}
            {% if printer.min_days_left is not none %}<span><strong>Jours min</strong> {{ printer.min_days_left|round(0)|int }}</span>{% endif %}
          </div>

          <!-- Alerte fin contrat proche -->
          {% if printer.alerte_fin_proche and printer.date_fin_contrat %}
            <div class="alert-fin-proche">‚è∞ Contrat se termine le {{ printer.date_fin_contrat }}</div>
          {% endif %}

          <!-- Slopes (loaded async) -->
          <div class="slopes-row" data-slopes-for="{{ printer.serial_display }}"></div>

          <!-- Toner quick buttons -->
          {% if printer.colors_present and printer.colors_present|length > 0 %}
            <div class="toner-btns">
              {% for c in printer.colors_present %}
                <button type="button" class="btn-toner-quick slope-btn"
                  data-serial="{{ printer.serial_display }}" data-color="{{ c }}"
                  data-bs-toggle="modal" data-bs-target="#slopeModal">{{ c }}</button>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <!-- Priority badge top-right -->
        <div>
          {% if printer.min_priority is not none %}
            <span class="badge-prio badge-prio-{{ printer.min_priority }}">P{{ printer.min_priority }}</span>
          {% endif %}
        </div>
      </div>

      <!-- TABLE -->
      <div class="pc-table-wrap">
        <table class="toner-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Toner</th>
              <th>Jours rest.</th>
              <th>Date rupture</th>
              <th>Priorit√©</th>
              <th>Derni√®re remont√©e</th>
              <th>KPAX</th>
              <th>%</th>
              <th>Type liv.</th>
              <th>Commentaire</th>
              <th>Consommation</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for r in printer.rows %}
              {% set rid = r[col_id] %}
              {% set prio = r.get(col_priority) %}
              {% set is_rupture = r.get('rupture_kpax') %}
              {% set color_val = (r.get('couleur_norm') or r.get('couleur') or '')|string|lower|trim %}

              <tr class="{% if rid in processed_ids %}row-sent{% endif %}">
                <td style="color:var(--text-muted)">{{ rid }}</td>
                <td><strong>{{ r.get(col_toner, '') }}</strong></td>
                <td>
                  {% set jours = r.get('jours_reel') %}
                  {% if jours is not none and jours != '' and jours == jours %}
                    {% if jours|float < 0 %}
                      <span style="color:var(--red); font-weight:700;">{{ jours|int }} j ‚ö†Ô∏è</span>
                    {% else %}
                      {{ jours|int }}
                    {% endif %}
                  {% else %}‚Äî{% endif %}
                </td>
                <td>{{ r.get(col_stockout, '‚Äî') | format_date }}</td>

                <td>
                  {% set prio = r.get('priorite_affichee', r.get(col_priority)) %}
                  {% if prio is not none %}
                    <span class="badge-prio badge-prio-{{ prio|int }}">P{{ prio|int }}</span>
                  {% endif %}
                </td>

                <td style="color:var(--text-muted); font-family:'DM Mono',monospace; font-size:0.75rem;">
                  {{ r.get(col_last_update, '‚Äî') }}
                </td>

                <td>
                  {% if is_rupture %}
                    <span class="badge-type badge-kpax-warn">‚ö†Ô∏è Pas de donn√©es</span>
                  {% else %}
                    <span class="badge-type badge-kpax-ok">‚úÖ √Ä jour</span>
                  {% endif %}
                </td>

                <td>
                  {% if r.get(col_last_pct) is not none %}
                    <strong>{{ r.get(col_last_pct)|round(0)|int }}%</strong>
                  {% else %}‚Äî{% endif %}
                </td>

                <td>
                  {% set tl = r.get(col_type_liv, '') %}
                  {% if tl == "contrat_maintenance" %}
                    <span class="badge-type badge-type-contrat">Contrat</span>
                  {% elif tl == "commande_simple" %}
                    <span class="badge-type badge-type-commande">Commande</span>
                  {% elif tl == "stock_seulement" %}
                    <span class="badge-type badge-type-stock">Stock</span>
                  {% elif tl %}
                    <span class="badge-type badge-type-inconnu">{{ tl }}</span>
                  {% endif %}
                </td>

                <td style="color:var(--text-muted); max-width:180px;">
                  {% set comment = r.get(col_comment, '') %}
                  {% if comment and 'üîî' in comment or (comment and 'inchang√©' in comment|lower) or (comment and 'Cartouche non chang√©e' in comment) %}
                    <span class="badge-unchanged">üîî Toner inchang√©</span><br>
                    <span style="font-size:0.75rem;">{{ comment }}</span>
                  {% else %}
                    {{ comment }}
                  {% endif %}
                </td>

                <!-- Consumption modal trigger -->
                <td>
                  {% if color_val %}
                    <button type="button" class="btn-consumption slope-btn"
                      data-serial="{{ printer.serial_display }}" data-color="{{ color_val }}"
                      data-bs-toggle="modal" data-bs-target="#slopeModal">üìà Voir</button>
                  {% else %}
                    <span style="color:var(--text-muted)">‚Äî</span>
                  {% endif %}
                </td>

                <!-- Action -->
                <td>
                  {% if rid not in processed_ids %}
                    <form method="post" action="{{ url_for('mark_processed', row_id=rid) }}" style="margin:0">
                      <button type="submit" class="btn-mark">‚úì Envoy√©</button>
                    </form>
                  {% else %}
                    <div style="display:flex;align-items:center;gap:0.4rem;">
                      <span class="badge-sent">‚úÖ Envoy√©</span>
                      <form method="post" action="{{ url_for('mark_unprocessed', row_id=rid) }}" style="margin:0">
                        <button type="submit" class="btn-unmark">‚Ü©</button>
                      </form>
                    </div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div><!-- /printer-card -->
    {% endfor %}

  {% else %}
    <div class="empty-state">
      <div class="icon">üîç</div>
      <div>Aucune recommandation trouv√©e avec ces filtres.</div>
    </div>
  {% endif %}

</div><!-- /main-wrap -->


<!-- ============================================================
     MODAL PENTE
     ============================================================ -->
<div class="modal fade" id="slopeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <div class="modal-title">üìà Pente de consommation</div>
          <div class="modal-subtitle" id="slopeSubtitle"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;margin-bottom:0.8rem;">
          <label style="font-size:0.78rem;color:var(--text-muted);">Toner :</label>
          <select class="slope-select" id="slopeColorSelect">
            <option value="black">black</option>
            <option value="cyan">cyan</option>
            <option value="magenta">magenta</option>
            <option value="yellow">yellow</option>
          </select>
          <span class="slope-value-pill" id="slopeValuePill">pente : ‚Äî</span>
          <span class="slope-source" id="slopeSource"></span>
        </div>
        <div class="alert-warn-modal d-none" id="slopeWarn"></div>
        <canvas id="slopeChart" height="140"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modal-close" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>


<!-- ============================================================
     SCRIPTS
     ============================================================ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  const prioData  = {{ priority_counts|tojson }};
  const colorData = {{ color_counts|tojson }};
</script>


<script>
  // ============================================================
  // THEME TOGGLE ‚Äî persisted in localStorage, shared key across pages
  // ============================================================
  (function(){
    const KEY  = 'tonerai-theme';          // 'dark' | 'light'
    const html = document.documentElement;
    const btn  = document.getElementById('themeToggle');
    const icon = document.getElementById('themeIcon');

    function apply(t) {
      if (t === 'light') { html.classList.add('light');    icon.textContent = '‚òÄÔ∏è'; }
      else               { html.classList.remove('light'); icon.textContent = 'üåô'; }
    }
    // init before first paint ‚Üí no flicker
    apply(localStorage.getItem(KEY) || 'dark');

    btn.addEventListener('click', () => {
      const next = html.classList.contains('light') ? 'dark' : 'light';
      apply(next);
      localStorage.setItem(KEY, next);
      requestAnimationFrame(reThemeCharts);   // update Chart.js axes live
    });
  })();

  // ============================================================
  // HELPERS
  // ============================================================
  function cssVar(n) { return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }

  function chartGridColor() { return cssVar('--border'); }
  function chartTickColor() { return cssVar('--text-muted'); }

  // ============================================================
  // BAR CHARTS
  // ============================================================
  function pChart(id, labels, values, colors) {
    const ctx = document.getElementById(id);
    if (!ctx || !labels.length) return null;
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: colors || 'rgba(108,99,255,0.55)',
          borderColor: 'rgba(108,99,255,0.8)',
          borderWidth: 1,
          borderRadius: 5,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: chartGridColor() }, ticks: { color: chartTickColor() } },
          y: { beginAtZero: true, grid: { color: chartGridColor() }, ticks: { color: chartTickColor(), precision: 0 } }
        }
      }
    });
  }

  const prioColors  = { '1':'#ef4444','2':'#f59e0b','3':'#eab308','4':'#22c55e' };
  const tonerColors = { black:'#888', cyan:'#06b6d4', magenta:'#e11d48', yellow:'#eab308' };

  const chartPrio  = pChart('priorityChart', Object.keys(prioData),  Object.values(prioData),  Object.keys(prioData).map(k => prioColors[k]  || '#6c63ff'));
  const chartColor = pChart('colorChart',    Object.keys(colorData), Object.values(colorData), Object.keys(colorData).map(k => tonerColors[k.toLowerCase()] || '#6c63ff'));

  // live re-colour axes after theme switch
  function reThemeCharts() {
    const g = chartGridColor(), t = chartTickColor();
    [chartPrio, chartColor].forEach(ch => {
      if (!ch) return;
      ch.options.scales.x.grid.color  = g;
      ch.options.scales.x.ticks.color = t;
      ch.options.scales.y.grid.color  = g;
      ch.options.scales.y.ticks.color = t;
      ch.update();
    });
  }

  // ============================================================
  // SLOPES ASYNC LOAD
  // ============================================================
  function slopeBadge(color, value) {
    const txt = (value === null || value === undefined || isNaN(value)) ? '‚Äî' : Number(value).toFixed(3) + ' %/j';
    return `<span class="slope-pill"><strong>${color}</strong> ${txt}</span>`;
  }

  document.querySelectorAll('[data-slopes-for]').forEach(async container => {
    const serial = container.dataset.slopesFor;
    try {
      const res  = await fetch(`/api/slopes?serial=${encodeURIComponent(serial)}`);
      const data = await res.json();
      if (data.error) return;
      const s = data.slopes || {};
      container.innerHTML =
        slopeBadge('black', s.black) + slopeBadge('cyan', s.cyan) +
        slopeBadge('magenta', s.magenta) + slopeBadge('yellow', s.yellow);
    } catch(e) { /* silent */ }
  });

  // ============================================================
  // MODAL PENTE
  // ============================================================
  const slopeModal     = document.getElementById('slopeModal');
  const slopeSubtitle  = document.getElementById('slopeSubtitle');
  const slopeColorSel  = document.getElementById('slopeColorSelect');
  const slopeValuePill = document.getElementById('slopeValuePill');
  const slopeSourceEl  = document.getElementById('slopeSource');
  const slopeWarn      = document.getElementById('slopeWarn');

  let slopeChart = null;
  let currentSerial = null;

  const COLOR_MAP = { black:'rgb(0,0,0)', cyan:'rgb(0,174,239)', magenta:'rgb(236,0,140)', yellow:'rgb(255,242,0)' };

  function destroySlopeChart() { if (slopeChart) { slopeChart.destroy(); slopeChart = null; } }

  function setWarn(msg) {
    if (!msg) { slopeWarn.classList.add('d-none'); slopeWarn.textContent=''; return; }
    slopeWarn.textContent = msg;
    slopeWarn.classList.remove('d-none');
  }

  async function loadAndRender(serial, color) {
    currentSerial = serial;
    const c = (color || 'black').toLowerCase();
    slopeSubtitle.textContent = `Imprimante : ${serial}`;
    slopeColorSel.value = c;
    slopeValuePill.textContent = 'pente : ‚Ä¶';
    slopeSourceEl.textContent = '';
    setWarn(null);
    destroySlopeChart();

    const res  = await fetch(`/api/consumption?serial=${encodeURIComponent(serial)}&color=${encodeURIComponent(c)}`);
    const data = await res.json();

    if (data.error) { setWarn('Erreur : ' + data.error); slopeValuePill.textContent = 'pente : ‚Äî'; return; }

    const slope = data.slope_pct_per_day;
    slopeValuePill.textContent = (slope === null || slope === undefined) ? 'pente : ‚Äî' : `pente : ${Number(slope).toFixed(3)} %/jour`;
    if (data.slope_source) slopeSourceEl.textContent = `(source : ${data.slope_source})`;

    const points = data.points || [];
    if (!points.length) { setWarn('Aucun historique KPAX pour ce toner.'); return; }

    const labels    = points.map(p => p.date);
    const values    = points.map(p => p.pct);
    const lineColor = COLOR_MAP[c] || 'rgb(108,99,255)';

    slopeChart = new Chart(document.getElementById('slopeChart'), {
      type: 'line',
      data: { labels, datasets: [{ label: `% (${c})`, data: values, tension: 0.25, pointRadius: 2, borderColor: lineColor, backgroundColor: lineColor }] },
      options: {
        responsive: true,
        plugins: { legend: { display: true, labels: { color: cssVar('--text') } } },
        scales: {
          x: { grid: { color: chartGridColor() }, ticks: { color: chartTickColor() } },
          y: { beginAtZero: true, suggestedMax: 100, grid: { color: chartGridColor() }, ticks: { color: chartTickColor() } }
        }
      }
    });
  }

  document.querySelectorAll('.slope-btn').forEach(btn => {
    btn.addEventListener('click', () => loadAndRender(btn.dataset.serial, btn.dataset.color || 'black'));
  });
  slopeColorSel.addEventListener('change', () => { if (currentSerial) loadAndRender(currentSerial, slopeColorSel.value); });
  slopeModal.addEventListener('hidden.bs.modal', () => { destroySlopeChart(); currentSerial = null; setWarn(null); slopeValuePill.textContent = 'pente : ‚Äî'; });
</script>

</body>
</html>